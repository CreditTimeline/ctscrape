name: Publish to Chrome Web Store

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  build-release:
    name: Build & Upload Release Asset
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4
      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version-file: '.node-version'
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - name: Build with observability
        run: pnpm build
        env:
          GA4_MEASUREMENT_ID: ${{ secrets.GA4_MEASUREMENT_ID }}
          GA4_API_SECRET: ${{ secrets.GA4_API_SECRET }}
          FARO_API_KEY: ${{ secrets.FARO_API_KEY }}
          FARO_APP_ID: ${{ secrets.FARO_APP_ID }}
          FARO_STACK_ID: ${{ secrets.FARO_STACK_ID }}
          FARO_SOURCE_MAP_ENDPOINT: ${{ secrets.FARO_SOURCE_MAP_ENDPOINT }}
      - run: pnpm zip
      - run: pnpm check-build
      - name: Upload ZIP as release asset
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          ZIP_FILE=$(ls .output/*.zip | head -1)
          gh release upload "${{ github.event.release.tag_name }}" "$ZIP_FILE" --clobber
      - uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: release-zip
          path: .output/*.zip
          include-hidden-files: true

  chrome-web-store:
    name: Chrome Web Store Submission
    needs: build-release
    runs-on: ubuntu-latest
    environment: chrome-web-store
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4
      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version-file: '.node-version'
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          name: release-zip
          path: .output/
      - name: Submit to Chrome Web Store
        run: pnpm wxt submit --chrome
        env:
          CHROME_EXTENSION_ID: ${{ secrets.CHROME_EXTENSION_ID }}
          CHROME_CLIENT_ID: ${{ secrets.CHROME_CLIENT_ID }}
          CHROME_CLIENT_SECRET: ${{ secrets.CHROME_CLIENT_SECRET }}
          CHROME_REFRESH_TOKEN: ${{ secrets.CHROME_REFRESH_TOKEN }}
